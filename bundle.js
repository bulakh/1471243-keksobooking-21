(()=>{"use strict";(()=>{const e=function(e){return e[Math.floor(Math.random()*e.length)]},t=function(e,t){return Math.floor(Math.random()*(t-e)+e)};window.util={getRandomArrElement:e,getRandomNumber:t,getRandomArrLength:function(n){const o=t(1,n.length),r=[...n],i=[];for(let t=0;t<o;t++){const t=e(r);i.push(t);const n=r.indexOf(t);n>-1&&r.splice(n,1)}return i},enterPressHandler:function(e,t){"Enter"===e.key&&t()},mouseClickHandler:function(e,t){1===e.which&&t()},escPressHandler:function(e,t){"Escape"===e.key&&(e.preventDefault(),t())}}})(),window.backend={load(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+" мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+o.timeout+" мс")})),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e=window.util.getRandomArrLength,t=window.util.getRandomArrElement,n=window.util.getRandomNumber,o=["Домик у озера","Уютные аппартаменты","Квартира под крыльцом","Таунхаус","Хижина в лесу"],r=["Шикарный вид на оригами","Жилье для уединения с самим собой","Вершина мира","Для скромного отпуска","Окунись в городскую суету"],i=["palace","flat","house","bungalow"],s=[1,2,3],a=[1,2,3],c=["12:00","13:00","14:00"],d=["wifi","dishwasher","parking","washer","elevator","conditioner"],u=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],l=function(l){const p=n(0,1200),f=n(130,630);return{author:{avatar:"img/avatars/user0"+l+".png"},offer:{title:t(o),address:p+", "+f,price:n(1e3,1e6),type:t(i),rooms:t(s),guests:t(a),checkin:t(c),checkout:t(c),features:e(d),description:t(r),photos:e(u)},location:{x:p,y:f}}};!function(e){const t=[];for(let e=0;e<8;e++)t.push(l[e])}()})(),window.debounce={setDebounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let s="any";window.filter={filterAllOptions:function(e){return function(e){const t=i.querySelectorAll(".map__checkbox");for(let n of t)n.checked&&(e=e.filter((function(e){return e.offer.features.includes(n.value)})));return e}(e=function(e){return e.filter((function(e){return r.value===s||e.offer.guests===parseInt(r.value,10)}))}(e=function(e){return e.filter((function(e){return o.value===s||e.offer.rooms===parseInt(o.value,10)}))}(e=function(e){return e.filter((function(e){switch(n.value){case s:return!0;case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<5e4;case"high":return e.offer.price>=5e4}return!1}))}(e=function(e){return e.filter((function(e){return t.value===s||e.offer.type===t.value}))}(e)))))},mapFilter:e}})(),(()=>{const e=window.util.escPressHandler,t=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector(".map__filters-container"),o={FLAT:"flat",BUNGALOW:"bungalow",HOUSE:"house",PALACE:"palace"},r={[o.FLAT]:"Квартира",[o.BUNGALOW]:"Бунгало",[o.HOUSE]:"Дом",[o.PALACE]:"Дворец"},i=function(){const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.card={createCard:function(o){const s=t.cloneNode(!0),a=s.querySelector(".popup__title");o.offer.title?a.textContent=o.offer.title:a.remove();const c=s.querySelector(".popup__text--address");o.offer.address?c.textContent=o.offer.address:c.remove();const d=s.querySelector(".popup__text--price");o.offer.price?d.textContent=o.offer.price+" руб/ночь":d.remove();const u=s.querySelector(".popup__type");o.offer.type?u.textContent=r[o.offer.type]:u.remove();const l=s.querySelector(".popup__text--capacity");o.offer.rooms&&o.offer.guests?l.textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей":l.remove();const p=s.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?p.textContent="Заезд после: "+o.offer.checkin+", выезд до "+o.offer.checkout:p.remove();const f=s.querySelector(".popup__features");o.offer.features.length?function(e,t){const n=document.createDocumentFragment();t.innerHTML="";for(let t=0;t<e.length;t++){const o=document.createElement("li"),r="popup__feature",i=`${r}--${e[t]}`;o.textContent=e[t],o.classList.add(r,i),n.appendChild(o)}t.appendChild(n)}(o.offer.features,f):f.remove();const m=s.querySelector(".popup__photos");o.offer.photos.length?function(e,t){const n=document.createDocumentFragment();t.innerHTML="";for(let t=0;t<e.length;t++){const o=document.createElement("img"),r="popup__photo";o.alt="Фотография жилья",o.src=e[t],o.style.width=45,o.style.height=40,o.classList.add(r),n.appendChild(o)}t.appendChild(n)}(o.offer.photos,m):m.remove();const v=s.querySelector(".popup__description");o.offer.description?v.textContent=o.offer.description:v.remove();const w=s.querySelector(".popup__avatar");o.author.avatar?w.src=o.author.avatar:w.remove(),o.location.x&&o.location.y?s.style="left: "+o.location.x+"px; top: "+o.location.y+"px;":s.style="left: 0px; top: 0px;",n.insertAdjacentElement("beforebegin",s);const y=function(t){e(t,h)},h=function(){i(),s.remove(),document.removeEventListener("keydown",y),g.removeEventListener("click",L)},L=function(){h()},g=document.querySelector(".popup__close");return g.addEventListener("click",L),document.addEventListener("keydown",y),s},deactivatePin:i,removeCards:function(){const e=document.querySelectorAll(".popup");for(let t of e)t.remove()},HouseType:o}})(),(()=>{const e=window.debounce.setDebounce,t=window.card.createCard,n=window.card.deactivatePin,o=window.card.removeCards,r=window.filter.mapFilter,i=window.filter.filterAllOptions,s={WIDTH:50,HEIGHT:70},a=document.querySelector(".map"),c=document.querySelector("#pin").content.querySelector(".map__pin"),d=a.querySelector(".map__pins"),u=function(e){const t=c.cloneNode(!0),n=t.querySelector("img");n.src=e.author.avatar,n.alt=e.offer.title;const o=e.location.x-s.WIDTH/2,r=e.location.y-s.HEIGHT;return t.style="left: "+o+"px; top: "+r+"px;",t.dataset.id=e.offer.address,t};let l=[];const p=function(e){let r;if(e.target.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))r=e.target;else{if(!e.target.parentElement.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))return;r=e.target.parentElement}n(),r.classList.add("map__pin--active"),o();let i=r.dataset.id;t(l.find((function(e){return i===e.offer.address})))},f=function(e){const t=document.createDocumentFragment();let n=5<e.length?5:e.length;for(let o=0;o<n;o++)t.appendChild(u(e[o]));d.appendChild(t)},m=function(){const e=a.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},v=function(){const e=i(l);o(),m(),f(e)};window.pin={PIN_SIZE:s,userMap:a,removePins:m,successLoadHandler:function(t){l=t,f(l),r.addEventListener("change",e(v))},activatePins:function(){d.addEventListener("click",p)},deactivatePins:function(){d.removeEventListener("click",p),r.removeEventListener("change",e(v))}}})(),(()=>{const e=window.util.escPressHandler,t=document.querySelector("main"),n=document.querySelector("#success").content,o=document.querySelector("#error").content,r=function(){t.querySelector(".success").remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",r)},i=function(t){e(t,r)},s=function(){t.querySelector(".error").remove(),document.removeEventListener("keydown",a),document.removeEventListener("click",s)},a=function(t){e(t,s)};window.modals={showErrorSend:function(){const e=o.cloneNode(!0);e.querySelector(".error").addEventListener("click",s),document.addEventListener("keydown",a),t.appendChild(e)},showSuccessSend:function(){const e=n.cloneNode(!0);e.querySelector(".success").addEventListener("click",r),document.addEventListener("keydown",i),t.appendChild(e)},errorLoadHandler:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; color: white",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form-header__input"),o=t.querySelector(".ad-form-header__avatar"),r=t.querySelector(".ad-form__input"),i=t.querySelector(".ad-form__photo-preview"),s=function(t,n){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result,n.matches(".hidden")&&n.classList.remove("hidden")})),e.readAsDataURL(o)}},a=function(){s(n,o)},c=function(){s(r,i)};window.upload={adForm:t,resetPreviewInputs:function(){r.removeEventListener("change",c),n.removeEventListener("change",a),o.src="img/muffin-grey.svg",i.src="#",i.classList.add("hidden")},activatePreviewInputs:function(){r.addEventListener("change",c),n.addEventListener("change",a)}}})(),(()=>{const e=window.pin.PIN_SIZE,t=window.upload.adForm,n=document.querySelector(".map__pin--main"),o=t.querySelector("#address"),r={X:e.WIDTH/2,Y:e.HEIGHT/2},i=function(e,t){o.value=e+", "+t},s=function(t){t.preventDefault();let o={x:t.clientX,y:t.clientY},s=!1;const a=function(t){t.preventDefault(),s=!0;const a=o.x-t.clientX,c=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const d=n.offsetLeft-a,u=n.offsetTop-c;d>=-32&&d<=1168&&(n.style.left=d+"px"),u>=130-r.Y&&u<=630&&(n.style.top=u+"px"),function(){let t=parseInt(n.style.left,10)+e.WIDTH/2,o=parseInt(n.style.top,10)+e.HEIGHT/2;i(t,o)}()},c=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c),s){const e=function(t){t.preventDefault(),n.removeEventListener("click",e)};n.addEventListener("click",e)}};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)};window.move={mainPin:n,HALF_PIN_SIZE:r,setAddress:i,activateMovePin:function(){n.addEventListener("mousedown",s)},deactivateMovePin:function(){n.removeEventListener("mousedown",s)}}})(),(()=>{const e=window.card.HouseType,t=window.upload.adForm,n="1",o="2",r="3",i="0",s=t.querySelector("#room_number"),a=t.querySelector("#capacity"),c=t.querySelector("#type"),d=t.querySelector("#price"),u=t.querySelector("#timein"),l=t.querySelector("#timeout"),p=function(){s.value===n?(a.value=parseInt(n,10),a.options[1].setAttribute("disabled","disabled")):s.value===o?(a.value=parseInt(o,10),a.options[0].setAttribute("disabled","disabled"),a.options[3].setAttribute("disabled","disabled"),a.options[2].removeAttribute("disabled","disabled"),a.options[1].removeAttribute("disabled","disabled")):s.value===r?(a.value=parseInt(r,10),a.options[3].setAttribute("disabled","disabled"),a.options[1].removeAttribute("disabled","disabled"),a.options[2].removeAttribute("disabled","disabled"),a.options[0].removeAttribute("disabled","disabled")):(a.value=parseInt(i,10),a.options[0].setAttribute("disabled","disabled"),a.options[2].setAttribute("disabled","disabled"),a.options[1].setAttribute("disabled","disabled"),a.options[3].setAttribute("disabled","disabled"))},f=function(){c.value===e.BUNGALOW?(d.min=0,d.placeholder=0):c.value===e.FLAT?(d.min=1e3,d.placeholder=1e3):c.value===e.HOUSE?(d.min=5e3,d.placeholder=5e3):c.value===e.PALACE&&(d.min=1e4,d.placeholder=1e4)},m=function(){l.value=u.value},v=function(){u.value=l.value};window.form={activateValidation:function(){s.addEventListener("change",p),c.addEventListener("change",f),u.addEventListener("change",m),l.addEventListener("change",v)},deactivateValidation:function(){s.removeEventListener("change",p),c.removeEventListener("change",f),u.removeEventListener("change",m),l.removeEventListener("change",v),a.options[0].setAttribute("disabled","disabled"),a.options[1].setAttribute("disabled","disabled"),t.reset()}}})(),(()=>{const e=window.util.enterPressHandler,t=window.util.mouseClickHandler,n=window.backend.load,o=window.backend.save,r=window.filter.mapFilter,i=window.card.removeCards,s=window.pin.userMap,a=window.pin.removePins,c=window.pin.activatePins,d=window.pin.deactivatePins,u=window.modals.showErrorSend,l=window.modals.showSuccessSend,p=window.modals.errorLoadHandler,f=window.upload.resetPreviewInputs,m=window.upload.activatePreviewInputs,v=window.upload.adForm,w=window.move.mainPin,y=window.move.HALF_PIN_SIZE,h=window.move.setAddress,L=window.move.activateMovePin,g=window.move.deactivateMovePin,_=window.form.activateValidation,b=window.form.deactivateValidation,E=v.querySelectorAll("fieldset"),S=document.querySelector(".map__filters"),q=S.querySelectorAll(".map__filter"),A=v.querySelector(".ad-form__reset"),k=parseInt(w.style.left,10),x=parseInt(w.style.top,10),H={X:k+y.X,Y:x+y.Y},P=function(e){for(let t of e)t.setAttribute("disabled","disabled")},I=function(e){for(let t of e)t.removeAttribute("disabled","disabled")},C=function(t){e(t,j)},T=function(e){t(e,j)},D=function(){l(),N()},F=function(){u(),N()},M=function(e){o(new FormData(v),D,F),e.preventDefault()},N=function(){s.classList.add("map--faded"),v.classList.add("ad-form--disabled"),w.style.left="570px",w.style.top="375px",a(),i(),P(E),P(q),r.reset(),w.addEventListener("keydown",C),w.addEventListener("mousedown",T),v.removeEventListener("submit",M),d(),g(),b(),f(),A.removeEventListener("click",N)};N();const j=function(){s.classList.remove("map--faded"),v.classList.remove("ad-form--disabled"),I(E),h(H.X,H.Y),n((function(e){window.pin.successLoadHandler(e),e.length&&(I(q),S.classList.remove("hidden"))}),p),w.removeEventListener("keydown",C),w.removeEventListener("mousedown",T),v.addEventListener("submit",M),c(),m(),L(),_(),A.addEventListener("click",N)}})()})();