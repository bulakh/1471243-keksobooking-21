(()=>{"use strict";(()=>{const e=function(e){return e[Math.floor(Math.random()*e.length)]},t=function(e,t){return Math.floor(Math.random()*(t-e)+e)};window.util={getRandomArrElement:e,getRandomNumber:t,getRandomArrLength:function(n){const o=t(1,n.length),r=[...n],i=[];for(let t=0;t<o;t++){const t=e(r);i.push(t);const n=r.indexOf(t);n>-1&&r.splice(n,1)}return i},onElemEnterPress:function(e,t){"Enter"===e.key&&t()},onElemMouseClick:function(e,t){1===e.which&&t()},onEscPress:function(e,t){"Escape"===e.key&&(e.preventDefault(),t())}}})(),window.backend={load(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+" мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+o.timeout+" мс")})),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e=window.util.getRandomArrLength,t=window.util.getRandomArrElement,n=window.util.getRandomNumber,o=["Домик у озера","Уютные аппартаменты","Квартира под крыльцом","Таунхаус","Хижина в лесу"],r=["Шикарный вид на оригами","Жилье для уединения с самим собой","Вершина мира","Для скромного отпуска","Окунись в городскую суету"],i=["palace","flat","house","bungalow"],s=[1,2,3],c=[1,2,3],a=["12:00","13:00","14:00"],d=["wifi","dishwasher","parking","washer","elevator","conditioner"],u=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],l=function(l){const p=n(0,1200),f=n(130,630);return{author:{avatar:"img/avatars/user0"+l+".png"},offer:{title:t(o),address:p+", "+f,price:n(1e3,1e6),type:t(i),rooms:t(s),guests:t(c),checkin:t(a),checkout:t(a),features:e(d),description:t(r),photos:e(u)},location:{x:p,y:f}}};!function(e){const t=[];for(let e=0;e<8;e++)t.push(l[e])}()})(),window.debounce={setDebounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let s="any";window.filter={filterAllOptions:function(e){return function(e){const t=i.querySelectorAll(".map__checkbox");for(let n of t)n.checked&&(e=e.filter((function(e){return e.offer.features.includes(n.value)})));return e}(e=function(e){return e.filter((function(e){return r.value===s||e.offer.guests===parseInt(r.value,10)}))}(e=function(e){return e.filter((function(e){return o.value===s||e.offer.rooms===parseInt(o.value,10)}))}(e=function(e){return e.filter((function(e){switch(n.value){case s:return!0;case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<5e4;case"high":return e.offer.price>=5e4}return!1}))}(e=function(e){return e.filter((function(e){return t.value===s||e.offer.type===t.value}))}(e)))))},mapFilter:e,housingRooms:o}})(),(()=>{const e=window.util.onEscPress,t=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector(".map__filters-container"),o={FLAT:"flat",BUNGALOW:"bungalow",HOUSE:"house",PALACE:"palace"},r={[o.FLAT]:"Квартира",[o.BUNGALOW]:"Бунгало",[o.HOUSE]:"Дом",[o.PALACE]:"Дворец"},i=function(){const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.card={createCard:function(o){const s=t.cloneNode(!0),c=s.querySelector(".popup__title");o.offer.title?c.textContent=o.offer.title:c.remove();const a=s.querySelector(".popup__text--address");o.offer.address?a.textContent=o.offer.address:a.remove();const d=s.querySelector(".popup__text--price");o.offer.price?d.textContent=o.offer.price+" руб/ночь":d.remove();const u=s.querySelector(".popup__type");o.offer.type?u.textContent=r[o.offer.type]:u.remove();const l=s.querySelector(".popup__text--capacity");o.offer.rooms&&o.offer.guests?l.textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей":l.remove();const p=s.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?p.textContent="Заезд после: "+o.offer.checkin+", выезд до "+o.offer.checkout:p.remove();const f=s.querySelector(".popup__features");o.offer.features.length?function(e,t){const n=document.createDocumentFragment();t.innerHTML="";for(let t=0;t<e.length;t++){const o=document.createElement("li"),r="popup__feature",i=`${r}--${e[t]}`;o.textContent=e[t],o.classList.add(r,i),n.appendChild(o)}t.appendChild(n)}(o.offer.features,f):f.remove();const m=s.querySelector(".popup__photos");o.offer.photos.length?function(e,t){const n=document.createDocumentFragment();t.innerHTML="";for(let t=0;t<e.length;t++){const o=document.createElement("img"),r="popup__photo";o.alt="Фотография жилья",o.src=e[t],o.style.width=45,o.style.height=40,o.classList.add(r),n.appendChild(o)}t.appendChild(n)}(o.offer.photos,m):m.remove();const v=s.querySelector(".popup__description");o.offer.description?v.textContent=o.offer.description:v.remove();const w=s.querySelector(".popup__avatar");o.author.avatar?w.src=o.author.avatar:w.remove(),o.location.x&&o.location.y?s.style="left: "+o.location.x+"px; top: "+o.location.y+"px;":s.style="left: 0px; top: 0px;",n.insertAdjacentElement("beforebegin",s);const y=function(t){e(t,h)},h=function(){i(),s.remove(),document.removeEventListener("keydown",y),E.addEventListener("click",_)},_=function(){h()},E=document.querySelector(".popup__close");return E.addEventListener("click",_),document.addEventListener("keydown",y),s},deactivatePin:i,removeCards:function(){const e=document.querySelectorAll(".popup");for(let t of e)t.remove()},HouseType:o}})(),(()=>{const e=window.debounce.setDebounce,t=window.filter.mapFilter,n=window.filter.filterAllOptions,o=window.card.createCard,r=window.card.deactivatePin,i=window.card.removeCards,s={WIDTH:50,HEIGHT:70},c=document.querySelector(".map"),a=document.querySelector("#pin").content.querySelector(".map__pin"),d=c.querySelector(".map__pins"),u=function(e){const t=a.cloneNode(!0),n=t.querySelector("img");n.src=e.author.avatar,n.alt=e.offer.title;const o=e.location.x-s.WIDTH/2,r=e.location.y-s.HEIGHT;return t.style="left: "+o+"px; top: "+r+"px;",t.dataset.id=e.offer.address,t};let l=[];d.addEventListener("click",(function(e){let t;if(e.target.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))t=e.target;else{if(!e.target.parentElement.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))return;t=e.target.parentElement}r(),t.classList.add("map__pin--active"),i();let n=t.dataset.id;o(l.find((function(e){return n===e.offer.address})))}));const p=function(e){const t=document.createDocumentFragment();let n=5<e.length?5:e.length;for(let o=0;o<n;o++)t.appendChild(u(e[o]));d.appendChild(t)},f=function(){const e=c.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},m=function(){const e=n(l);i(),f(),p(e)};window.pin={PIN_SIZE:s,userMap:c,successLoadHandler:function(n){l=n,p(l),t.addEventListener("change",e(m))},removePins:f}})(),(()=>{const e=window.util.onEscPress,t=document.querySelector("main"),n=document.querySelector("#success").content,o=document.querySelector("#error").content,r=function(){t.querySelector(".success").remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",r)},i=function(t){e(t,r)},s=function(){t.querySelector(".error").remove(),document.removeEventListener("keydown",c),document.removeEventListener("click",s)},c=function(t){e(t,s)};window.modals={showErrorSend:function(){const e=o.cloneNode(!0);e.querySelector(".error__button").addEventListener("click",s),e.querySelector(".error").addEventListener("click",s),document.addEventListener("keydown",c),t.appendChild(e)},showSuccessSend:function(){const e=n.cloneNode(!0);e.querySelector(".success").addEventListener("click",r),document.addEventListener("keydown",i),t.appendChild(e)},errorLoadHandler:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; color: white",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form-header__input"),o=t.querySelector(".ad-form-header__avatar"),r=t.querySelector(".ad-form__input"),i=t.querySelector(".ad-form__photo-preview"),s=function(t,n){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result,n.matches(".hidden")&&n.classList.remove("hidden")})),e.readAsDataURL(o)}},c=function(){s(n,o)},a=function(){s(r,i)};window.upload={adForm:t,resetPreviewInputs:function(){r.removeEventListener("change",a),n.removeEventListener("change",c),o.src="img/muffin-grey.svg",i.src="#",i.classList.add("hidden")},activatePreviewInputs:function(){r.addEventListener("change",a),n.addEventListener("change",c)}}})(),(()=>{const e=window.pin.userMap,t=window.pin.PIN_SIZE,n=window.pin.removePins,o=window.backend.load,r=window.backend.save,i=window.modals.showErrorSend,s=window.modals.errorLoadHandler,c=window.modals.showSuccessSend,a=window.filter.mapFilter,d=window.upload.resetPreviewInputs,u=window.upload.activatePreviewInputs,l=window.upload.adForm,p=document.querySelector(".map__pin--main"),f=l.querySelectorAll("fieldset"),m=document.querySelector(".map__filters"),v=m.querySelectorAll(".map__filter"),w=l.querySelector("#address"),y=parseInt(p.style.left,10),h=parseInt(p.style.top,10),_={X:t.WIDTH/2,Y:t.HEIGHT/2},E={X:y+_.X,Y:h+_.Y},g=function(e,t){w.value=e+", "+t},L=function(e){for(let t of e)t.setAttribute("disabled","disabled")},b=function(e){for(let t of e)t.removeAttribute("disabled","disabled")},S=function(e){window.util.onElemEnterPress(e,C)},q=function(e){window.util.onElemMouseClick(e,C)},A=function(){c(),I()},k=function(){i(),I()},x=function(e){r(new FormData(l),A,k),e.preventDefault()},I=function(){e.classList.add("map--faded"),l.classList.add("ad-form--disabled"),p.style.left="570px",p.style.top="375px",n(),L(f),L(v),l.reset(),a.reset(),p.addEventListener("keydown",S),p.addEventListener("mousedown",q),l.removeEventListener("submit",x),d()};I();const C=function(){e.classList.remove("map--faded"),l.classList.remove("ad-form--disabled"),b(f),g(E.X,E.Y),o((function(e){window.pin.successLoadHandler(e),e.length&&(b(v),m.classList.remove("hidden"))}),s),p.removeEventListener("keydown",S),p.removeEventListener("mousedown",q),l.addEventListener("submit",x),u()};window.map={adForm:l,mainPin:p,HALF_PIN_SIZE:_,setAddress:g}})(),(()=>{const e=window.pin.PIN_SIZE,t=window.map.mainPin,n=window.map.setAddress,o=window.map.HALF_PIN_SIZE;t.addEventListener("mousedown",(function(r){r.preventDefault();let i={x:r.clientX,y:r.clientY},s=!1;const c=function(r){r.preventDefault(),s=!0;const c=i.x-r.clientX,a=i.y-r.clientY;i={x:r.clientX,y:r.clientY};const d=t.offsetLeft-c,u=t.offsetTop-a;d>=-32&&d<=1168&&(t.style.left=d+"px"),u>=130-o.Y&&u<=630&&(t.style.top=u+"px"),function(){let o=parseInt(t.style.left,10)+e.WIDTH/2,r=parseInt(t.style.top,10)+e.HEIGHT/2;n(o,r)}()},a=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",a),s){const e=function(n){n.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",c),document.addEventListener("mouseup",a)}))})(),(()=>{const e=window.map.adForm,t=window.card.HouseType,n=e.querySelector("#room_number"),o=e.querySelector("#capacity"),r=e.querySelector("#type"),i=e.querySelector("#price"),s=e.querySelector("#timein"),c=e.querySelector("#timeout");n.addEventListener("change",(function(){"1"===n.value?(o.value=1,o.options[1].setAttribute("disabled","disabled")):"2"===n.value?(o.value=2,o.options[0].setAttribute("disabled","disabled"),o.options[3].setAttribute("disabled","disabled"),o.options[2].removeAttribute("disabled","disabled"),o.options[1].removeAttribute("disabled","disabled")):"3"===n.value?(o.value=3,o.options[3].setAttribute("disabled","disabled"),o.options[1].removeAttribute("disabled","disabled"),o.options[2].removeAttribute("disabled","disabled"),o.options[0].removeAttribute("disabled","disabled")):(o.value=0,o.options[0].setAttribute("disabled","disabled"),o.options[2].setAttribute("disabled","disabled"),o.options[1].setAttribute("disabled","disabled"),o.options[3].setAttribute("disabled","disabled"))})),r.addEventListener("change",(function(){r.value===t.BUNGALOW?(i.min=0,i.placeholder=0):r.value===t.FLAT?(i.min=1e3,i.placeholder=1e3):r.value===t.HOUSE?(i.min=5e3,i.placeholder=5e3):r.value===t.PALACE&&(i.min=1e4,i.placeholder=1e4)})),s.addEventListener("change",(function(){c.value=s.value})),c.addEventListener("change",(function(){s.value=c.value}))})()})();